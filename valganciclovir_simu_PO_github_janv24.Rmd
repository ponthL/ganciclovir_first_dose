---
title: "Ganciclovir"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(truncnorm)
library(mrgsolve)

library(mrgsolve)
library(mapbayr)

library(dplyr)

library(magrittr)
library(ggplot2)
library(PKNCA)
library(ggplot2)
library(ggcorrplot)

```

simulation Age/poids/clairance 

```{r}


####for girls


### weight 0/1 ans 
set.seed(2345)
gen_1 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=8.3, b=13.3, mean = 10.93, sd = 3))}
W_1 <- 1:1 %>% map_df(gen_1)%>% dplyr::mutate(age=1) 

### height 0/1 ans  
set.seed(2345)
taille_1 <-  function (x) {tibble(ID1 = x, taille= rtruncnorm(300, a=68, b=95, mean = 83, sd = 3))}
T_1 <- 1:1 %>% map_df(taille_1)

W_1 <- W_1 %>% bind_cols(T_1) %>% select(Pds,taille,age)
summary(W_1)

### 2 years

set.seed(2345)
gen_2 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=10, b=18, mean =13.3, sd = 3.5))}
W_2 <- 1:1 %>% map_df(gen_2) %>% mutate(age=2)

####  
set.seed(2345)
taille_2 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=82, b=100, mean = 90, sd = 3))}
T_2 <- 1:1 %>% map_df(taille_2)

W_2 <- W_2 %>% bind_cols(T_2) %>% select(Pds,taille,age)
summary(W_2)


### with 1 & 2 years old
Simu_inf2 <- W_1 %>% bind_rows(W_2) 
summary(Simu_inf2)

### creatinine simulation

set.seed(2345)
gen_Clcreat <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(600, a=20, b=250, mean =35, sd = 35))}
Clcreat<- 1:1 %>% map_df(gen_Clcreat)

Simu_inf2 <- Simu_inf2 %>% bind_cols(Clcreat)
Simu_inf2 <- as.tibble(Simu_inf2 )%>% select(Pds,Clcreat,age,taille)%>% mutate(ID = 1:600)

### 3, 4, 5 years old 

set.seed(2345)
gen_3 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=12, b=20, mean =14.3, sd = 3.5))}
W_3 <- 1:1 %>% map_df(gen_3) %>% mutate(age=3)

 
set.seed(2345)
taille_3 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=88, b=110, mean = 98, sd = 3))}
T_3 <- 1:1 %>% map_df(taille_3)

W_3 <- W_3 %>% bind_cols(T_3) %>% select(Pds,taille,age)


set.seed(2345)
gen_4 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=12.4, b=23.3, mean =15.3, sd = 3.5))}
W_4<- 1:1 %>% map_df(gen_4) %>% mutate(age=4)

### 4 years
set.seed(2345)
taille_4 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=93, b=120, mean = 118, sd = 3.5))}
T_4 <- 1:1 %>% map_df(taille_4)

W_4 <- W_4 %>% bind_cols(T_4)%>% select(Pds,taille,age)


set.seed(2345)
gen_5 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=14.2, b=29.7, mean =19.5, sd = 3.5))}
W_5<- 1:1 %>% map_df(gen_5) %>% mutate(age=5)

set.seed(2345)
taille_5 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=100, b=129, mean = 112, sd = 3.5))}
T_5 <- 1:1 %>% map_df(taille_5)

W_5 <- W_5 %>% bind_cols(T_5)%>% select(Pds,taille,age)


Simu3_5 <- W_3 %>% bind_rows( W_4) %>% bind_rows( W_5)
set.seed(2345)
gen_Clcreat3_5 <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(900, a=20, b=250, mean =35, sd = 35))}
Clcreat3_5<- 1:1 %>% map_df(gen_Clcreat3_5)


Simu3_5 <- Simu3_5 %>% bind_cols(Clcreat3_5)
Simu3_5 <- as.tibble(Simu3_5) %>% select(Pds,Clcreat,age,taille)%>% mutate (ID=601:1500)

###  6/7/8/9/10/11 years old


set.seed(2345)
gen_6 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=16, b=32, mean =22, sd = 3.5))}
W_6<- 1:1 %>% map_df(gen_6) %>% mutate(age=6)

set.seed(2345)
taille_6 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=104, b=134, mean = 124, sd = 3.5))}
T_6 <- 1:1 %>% map_df(taille_6)

W_6 <- W_6 %>% bind_cols(T_6)%>% select(Pds,taille,age)



set.seed(2345)
gen_7 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=18, b=38.3, mean =24, sd = 5.5))}
W_7<- 1:1 %>% map_df(gen_7) %>% mutate(age=7)
set.seed(2345)
taille_7 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=108, b=143, mean = 124, sd = 5.5))}
T_7 <- 1:1 %>% map_df(taille_7)

W_7 <- W_7 %>% bind_cols(T_7)%>% select(Pds,taille,age)


set.seed(2345)
gen_8 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=19, b=44, mean =28.2, sd = 6.5))}
W_8<- 1:1 %>% map_df(gen_8) %>% mutate(age=8)
set.seed(2345)
taille_8 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=108, b=152, mean = 137.7, sd = 6.5))}
T_8 <- 1:1 %>% map_df(taille_8)

W_8 <- W_8 %>% bind_cols(T_8)%>% select(Pds,taille,age)


set.seed(2345)
gen_9 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=21, b=49.5, mean =29.5, sd = 7.5))}
W_9<- 1:1 %>% map_df(gen_9) %>% mutate(age=9)
set.seed(2345)
taille_9 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=118, b=154, mean = 135, sd = 7.5))}
T_9 <- 1:1 %>% map_df(taille_9)

W_9 <- W_9 %>% bind_cols(T_9)%>% select(Pds,taille,age)


set.seed(2345)
gen_10 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=22, b=52, mean =323.5, sd = 7.5))}
W_10<- 1:1 %>% map_df(gen_10)  %>% mutate(age=10)
set.seed(2345)
taille_10 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=122, b=165, mean = 141, sd = 7.5))}
T_10 <- 1:1 %>% map_df(taille_10)

W_10 <- W_10 %>% bind_cols(T_10)%>% select(Pds,taille,age)



set.seed(2345)
gen_11 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=24.5, b=64.5, mean =40, sd = 7.5))}
W_11<- 1:1 %>% map_df(gen_11)  %>% mutate(age=11)

set.seed(2345)
taille_11 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=124, b=175, mean = 148, sd = 7.5))}
T_11 <- 1:1 %>% map_df(taille_11)

W_11 <- W_11 %>% bind_cols(T_11)%>% select(Pds,taille,age)


Simu6_11 <- W_6 %>% bind_rows(W_7)%>% bind_rows(W_8)%>% bind_rows(W_9)%>% bind_rows(W_10)%>% bind_rows(W_11)
set.seed(2345)
gen_Clcreat6_11 <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(1800, a=20, b=250, mean =35, sd = 35))}
Clcreat6_11<- 1:1 %>% map_df(gen_Clcreat6_11)


Simu6_11 <- Simu6_11 %>% bind_cols(Clcreat6_11)
Simu6_11 <- as.tibble(Simu6_11) %>% select(Pds,Clcreat,age,taille)%>% mutate (ID=1501:3300)
summary(Simu6_11)

### >=12 years old 

set.seed(2345)
gen_12 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=28, b=75, mean =46.5, sd = 8.5))}
W_12<- 1:1 %>% map_df(gen_12) %>% mutate(age=12)
set.seed(2345)
taille_12 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=125, b=182, mean = 155, sd = 8.5))}
T_12 <- 1:1 %>% map_df(taille_12)

W_12 <- W_12 %>% bind_cols(T_12)%>% select(Pds,taille,age)



set.seed(2345)
gen_13 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=28, b=80, mean =48, sd = 9.5))}
W_13<- 1:1 %>% map_df(gen_13) %>% mutate(age=13)
set.seed(2345)
taille_13 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=132, b=180, mean = 152, sd = 9.5))}
T_13 <- 1:1 %>% map_df(taille_13)

W_13 <- W_13 %>% bind_cols(T_13)%>% select(Pds,taille,age)


set.seed(2345)
gen_14 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=33, b=86, mean =50, sd = 10.5))}
W_14<- 1:1 %>% map_df(gen_14) %>% mutate(age=14)
set.seed(2345)
taille_14 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=140, b=190, mean = 165, sd = 10.5))}
T_14 <- 1:1 %>% map_df(taille_14)

W_14 <- W_14 %>% bind_cols(T_14)%>% select(Pds,taille,age)


set.seed(2345)
gen_15 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=36, b=92, mean =55, sd = 10.5))}
W_15<- 1:1 %>% map_df(gen_15) %>% mutate(age=15)
set.seed(2345)
taille_15 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=144, b=195, mean = 165, sd = 10.5))}
T_15 <- 1:1 %>% map_df(taille_15)

W_15 <- W_15 %>% bind_cols(T_15)%>% select(Pds,taille,age)


set.seed(2345)
gen_16 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=40, b=95, mean =57, sd = 10.5))}
W_16<- 1:1 %>% map_df(gen_16) %>% mutate(age=16)
set.seed(2345)
taille_16 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=144, b=195, mean = 165, sd = 10.5))}
T_16 <- 1:1 %>% map_df(taille_16)

W_16 <- W_16 %>% bind_cols(T_16)%>% select(Pds,taille,age)



set.seed(2345)
gen_17 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=43, b=99, mean =59, sd = 10.5))}
W_17<- 1:1 %>% map_df(gen_17) %>% mutate(age=17)
set.seed(2345)
taille_17 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=144, b=195, mean = 165, sd = 10.5))}
T_17 <- 1:1 %>% map_df(taille_17)

W_17 <- W_17 %>% bind_cols(T_17)%>% select(Pds,taille,age)



set.seed(2345)
gen_18 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=43, b=99, mean =59, sd = 10.5))}
W_18<- 1:1 %>% map_df(gen_18) %>% mutate(age=18)
set.seed(2345)
taille_18 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=144, b=195, mean = 165, sd = 10.5))}
T_18 <- 1:1 %>% map_df(taille_18)

W_18 <- W_18 %>% bind_cols(T_18)%>% select(Pds,taille,age)




simu12_18 <- W_12 %>% bind_rows(W_13) %>% bind_rows(W_14) %>% bind_rows(W_15) %>% bind_rows(W_16) %>% bind_rows(W_17) %>% bind_rows(W_18)
set.seed(2345)
gen_Clcreat12_18 <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(2100,a=20, b=250, mean =35, sd = 35))}
Clcreat12_18<- 1:1 %>% map_df(gen_Clcreat12_18)


simu12_18 <- simu12_18 %>% bind_cols(Clcreat12_18)
Simu12_18 <- as.tibble(simu12_18) %>% select(Pds,Clcreat,age,taille)%>% mutate (ID=3301:5400)

summary(Simu12_18)


Simu_totale_fille <- Simu_inf2 %>% bind_rows(Simu3_5)%>% bind_rows(Simu6_11)%>% bind_rows(simu12_18) %>% select(Pds,Clcreat,age,taille)%>% mutate(ID=c(1:5400))%>% mutate(SEX="fille")

### we calculate the creatine clairance for girls
Simu_totale_fille <- Simu_totale_fille %>% mutate(Clcreat2=case_when(age<=1~(40*taille/Clcreat),age>1 & age<=12~(49*taille/Clcreat),age>12~(53*taille/Clcreat) ))
Simu_totale_fille <- Simu_totale_fille %>%select(-Clcreat) %>%rename (Clcreat=Clcreat2)

summary(Simu_totale_fille)


### for  boys 


### weight 0/1 ans 
set.seed(2345)
gen_1 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=7.3, b=16.3, mean = 11.93, sd = 3))}
W_1 <- 1:1 %>% map_df(gen_1)%>% dplyr::mutate(age=1) 

  
set.seed(2345)
taille_1 <-  function (x) {tibble(ID1 = x, taille= rtruncnorm(300, a=72, b=95, mean = 83, sd = 3))}
T_1 <- 1:1 %>% map_df(taille_1)

W_1 <- W_1 %>% bind_cols(T_1) %>% select(Pds,taille,age)
summary(W_1)


set.seed(2345)
gen_2 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=9.5, b=20, mean =13.8, sd = 3.5))}
W_2 <- 1:1 %>% map_df(gen_2) %>% mutate(age=2)


set.seed(2345)
taille_2 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=79, b=108, mean = 92, sd = 3))}
T_2 <- 1:1 %>% map_df(taille_2)

W_2 <- W_2 %>% bind_cols(T_2) %>% select(Pds,taille,age)
summary(W_2)



Simu_inf2 <- W_1 %>% bind_rows(W_2) 
summary(Simu_inf2)

### simulation creatinine

set.seed(2345)
gen_Clcreat <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(600,a=20, b=250, mean =35, sd = 35))}
Clcreat<- 1:1 %>% map_df(gen_Clcreat)

Simu_inf2 <- Simu_inf2 %>% bind_cols(Clcreat)
Simu_inf2 <- as.tibble(Simu_inf2 )%>% select(Pds,Clcreat,age,taille)%>% mutate(ID = 1:600)

### 3, 4, 5 

set.seed(2345)
gen_3 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=11, b=22, mean =15.3, sd = 3.5))}
W_3 <- 1:1 %>% map_df(gen_3) %>% mutate(age=3)


set.seed(2345)
taille_3 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=86, b=118, mean = 100, sd = 3))}
T_3 <- 1:1 %>% map_df(taille_3)

W_3 <- W_3 %>% bind_cols(T_3) %>% select(Pds,taille,age)


set.seed(2345)
gen_4 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=12.4, b=25.3, mean =17.3, sd = 3.5))}
W_4<- 1:1 %>% map_df(gen_4) %>% mutate(age=4)

 
set.seed(2345)
taille_4 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=92, b=124, mean = 108, sd = 3.5))}
T_4 <- 1:1 %>% map_df(taille_4)

W_4 <- W_4 %>% bind_cols(T_4)%>% select(Pds,taille,age)


set.seed(2345)
gen_5 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=15, b=30, mean =19.8, sd = 3.5))}
W_5<- 1:1 %>% map_df(gen_5) %>% mutate(age=5)

set.seed(2345)
taille_5 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=98, b=137, mean = 115, sd = 3.5))}
T_5 <- 1:1 %>% map_df(taille_5)

W_5 <- W_5 %>% bind_cols(T_5)%>% select(Pds,taille,age)


Simu3_5 <- W_3 %>% bind_rows( W_4) %>% bind_rows( W_5)
set.seed(2345)
gen_Clcreat3_5 <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(900, a=20, b=250, mean =35, sd = 35))}
Clcreat3_5<- 1:1 %>% map_df(gen_Clcreat3_5)


Simu3_5 <- Simu3_5 %>% bind_cols(Clcreat3_5)
Simu3_5 <- as.tibble(Simu3_5) %>% select(Pds,Clcreat,age,taille)%>% mutate (ID=601:1500)

###  6/7/8/9/10/11


set.seed(2345)
gen_6 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=15, b=30, mean =22, sd = 3.5))}
W_6<- 1:1 %>% map_df(gen_6) %>% mutate(age=6)

set.seed(2345)
taille_6 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=102, b=140, mean = 122, sd = 3.5))}
T_6 <- 1:1 %>% map_df(taille_6)

W_6 <- W_6 %>% bind_cols(T_6)%>% select(Pds,taille,age)



set.seed(2345)
gen_7 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=17, b=35.3, mean =25, sd = 5.5))}
W_7<- 1:1 %>% map_df(gen_7) %>% mutate(age=7)
set.seed(2345)
taille_7 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=108, b=145, mean = 125, sd = 5.5))}
T_7 <- 1:1 %>% map_df(taille_7)

W_7 <- W_7 %>% bind_cols(T_7)%>% select(Pds,taille,age)


set.seed(2345)
gen_8 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=19, b=48, mean =28, sd = 6.5))}
W_8<- 1:1 %>% map_df(gen_8) %>% mutate(age=8)
set.seed(2345)
taille_8 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=112, b=152, mean = 132, sd = 6.5))}
T_8 <- 1:1 %>% map_df(taille_8)

W_8 <- W_8 %>% bind_cols(T_8)%>% select(Pds,taille,age)



set.seed(2345)
gen_9 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=21, b=49.5, mean =29.5, sd = 7.5))}
W_9<- 1:1 %>% map_df(gen_9) %>% mutate(age=9)
set.seed(2345)
taille_9 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=116, b=160, mean = 138, sd = 7.5))}
T_9 <- 1:1 %>% map_df(taille_9)

W_9 <- W_9 %>% bind_cols(T_9)%>% select(Pds,taille,age)


set.seed(2345)
gen_10 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=23, b=62, mean =33.5, sd = 7.5))}
W_10<- 1:1 %>% map_df(gen_10)  %>% mutate(age=10)
set.seed(2345)
taille_10 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=120, b=165, mean = 142, sd = 7.5))}
T_10 <- 1:1 %>% map_df(taille_10)

W_10 <- W_10 %>% bind_cols(T_10)%>% select(Pds,taille,age)



set.seed(2345)
gen_11 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=24.5, b=69.5, mean =38, sd = 7.5))}
W_11<- 1:1 %>% map_df(gen_11)  %>% mutate(age=11)

set.seed(2345)
taille_11 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=125, b=173, mean = 148, sd = 7.5))}
T_11 <- 1:1 %>% map_df(taille_11)

W_11 <- W_11 %>% bind_cols(T_11)%>% select(Pds,taille,age)


Simu6_11 <- W_6 %>% bind_rows(W_7)%>% bind_rows(W_8)%>% bind_rows(W_9)%>% bind_rows(W_10)%>% bind_rows(W_11)
set.seed(2345)
gen_Clcreat6_11 <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(1800, a=20, b=250, mean =35, sd = 35))}
Clcreat6_11<- 1:1 %>% map_df(gen_Clcreat6_11)


Simu6_11 <- Simu6_11 %>% bind_cols(Clcreat6_11)
Simu6_11 <- as.tibble(Simu6_11) %>% select(Pds,Clcreat,age,taille)%>% mutate (ID=1501:3300)
summary(Simu6_11)

### others >=12 years old

set.seed(2345)
gen_12 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=26, b=80, mean =42, sd = 8.5))}
W_12<- 1:1 %>% map_df(gen_12) %>% mutate(age=12)
set.seed(2345)
taille_12 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=128, b=182, mean = 155, sd = 8.5))}
T_12 <- 1:1 %>% map_df(taille_12)

W_12 <- W_12 %>% bind_cols(T_12)%>% select(Pds,taille,age)



set.seed(2345)
gen_13 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=28, b=80, mean =48, sd = 9.5))}
W_13<- 1:1 %>% map_df(gen_13) %>% mutate(age=13)
set.seed(2345)
taille_13 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=132, b=190, mean = 161, sd = 9.5))}
T_13 <- 1:1 %>% map_df(taille_13)

W_13 <- W_13 %>% bind_cols(T_13)%>% select(Pds,taille,age)


set.seed(2345)
gen_14 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=33, b=92, mean =55, sd = 10.5))}
W_14<- 1:1 %>% map_df(gen_14) %>% mutate(age=14)
set.seed(2345)
taille_14 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=136, b=195, mean = 177, sd = 10.5))}
T_14 <- 1:1 %>% map_df(taille_14)

W_14 <- W_14 %>% bind_cols(T_14)%>% select(Pds,taille,age)


set.seed(2345)
gen_15 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=36, b=92, mean =60, sd = 10.5))}
W_15<- 1:1 %>% map_df(gen_15) %>% mutate(age=15)
set.seed(2345)
taille_15 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=144, b=195, mean = 172, sd = 10.5))}
T_15 <- 1:1 %>% map_df(taille_15)

W_15 <- W_15 %>% bind_cols(T_15)%>% select(Pds,taille,age)


set.seed(2345)
gen_16 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=40, b=95, mean =62, sd = 10.5))}
W_16<- 1:1 %>% map_df(gen_16) %>% mutate(age=16)
set.seed(2345)
taille_16 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=144, b=195, mean = 175, sd = 10.5))}
T_16 <- 1:1 %>% map_df(taille_16)

W_16 <- W_16 %>% bind_cols(T_16)%>% select(Pds,taille,age)



set.seed(2345)
gen_17 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=43, b=110, mean =65, sd = 10.5))}
W_17<- 1:1 %>% map_df(gen_17) %>% mutate(age=17)
set.seed(2345)
taille_17 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=154, b=195, mean = 175, sd = 10.5))}
T_17 <- 1:1 %>% map_df(taille_17)

W_17 <- W_17 %>% bind_cols(T_17)%>% select(Pds,taille,age)



set.seed(2345)
gen_18 <-  function (x) {tibble(ID1 = x, Pds= rtruncnorm(300, a=43, b=99, mean =65, sd = 10.5))}
W_18<- 1:1 %>% map_df(gen_18) %>% mutate(age=18)
set.seed(2345)
taille_18 <-  function (x) {tibble(ID1 = x, taille = rtruncnorm(300, a=144, b=195, mean = 175, sd = 10.5))}
T_18 <- 1:1 %>% map_df(taille_18)

W_18 <- W_18 %>% bind_cols(T_18)%>% select(Pds,taille,age)




simu12_18 <- W_12 %>% bind_rows(W_13) %>% bind_rows(W_14) %>% bind_rows(W_15) %>% bind_rows(W_16) %>% bind_rows(W_17) %>% bind_rows(W_18)

gen_Clcreat12_18 <-  function (x) {tibble(ID1 = x, Clcreat= rtruncnorm(2100,a=20, b=250, mean =35, sd = 35))}
Clcreat12_18<- 1:1 %>% map_df(gen_Clcreat12_18)


simu12_18 <- simu12_18 %>% bind_cols(Clcreat12_18)
Simu12_18 <- as.tibble(simu12_18) %>% select(Pds,Clcreat,age,taille)%>% mutate (ID=3301:5400)

summary(Simu12_18)






Simu_totale_boy<- Simu_inf2 %>% bind_rows(Simu3_5)%>% bind_rows(Simu6_11)%>% bind_rows(simu12_18) %>% select(Pds,Clcreat,age,taille)%>% mutate(ID=c(1:5400))%>% mutate(SEX="garcon")

### we calculate the creatine clairance for boys 

Simu_totale_boy <- Simu_totale_boy %>% mutate(Clcreat2=case_when(age<=1~(40*taille/Clcreat),age>1 & age<=12~(49*taille/Clcreat),age>12~(62*taille/Clcreat) ))%>%select(-Clcreat) %>%rename (Clcreat=Clcreat2)
summary(Simu_totale_boy)



#boys+girls

Simu_totale <- Simu_totale_boy %>% bind_rows(Simu_totale_fille) %>% select(-ID)%>% mutate(ID=c(1:10800))
### on calcule SC Mosteller et 

Simu_totale <- Simu_totale %>% mutate(SC_mosteller= sqrt((taille*Pds)/3600)) 
summary(Simu_totale)

#### on rajoute le type de greffe

Simu_totale<- Simu_totale %>% mutate(type_greffe= sample(1:2,10800,replace=T))
Simu_totale$type_greffe=as.factor(Simu_totale$type_greffe)


Simu_totale<- Simu_totale %>% mutate(greffe= case_when(type_greffe=="1"~"solide",type_greffe=="2"~"moelle" ))%>% select(-type_greffe)
#
                                      





### posology PO ganciclovir

Simu_totale_avec_dose2 <- Simu_totale %>%mutate (Clcreat2 = case_when(Clcreat<150 ~ Clcreat, Clcreat>=150 ~ 150))%>%mutate(amt= 7*SC_mosteller*Clcreat2)%>% mutate(amt2 = case_when(amt<900 ~ amt, amt>=900 ~ 900))
                                                             
summary(Simu_totale_avec_dose2)



#### we separated into 3 datasets  for simulations with Franck, Facchin and nguyen models

set.seed(123)  
sample <- sample.int(n = nrow(Simu_totale_avec_dose2), size = floor(.333*nrow(Simu_totale_avec_dose2)), replace = F)

data_bene <- Simu_totale_avec_dose2[sample, ]
Simu_totale_avec_dose2_2  <- Simu_totale_avec_dose2[-sample, ]


set.seed(123)  
sample2 <- sample.int(n = nrow(Simu_totale_avec_dose2_2), size = floor(.5*nrow(Simu_totale_avec_dose2_2)), replace = F)

data_nguyen <- Simu_totale_avec_dose2_2[sample2, ]
Simu_totale_avec_dose2_3  <- Simu_totale_avec_dose2_2[-sample2, ]




data_facchin <- Simu_totale_avec_dose2_3

data_bene2 <- data_bene %>% mutate(methode="bene")
data_nguyen2 <- data_nguyen %>% mutate(methode="nguyen")
data_facchin2 <- data_facchin %>% mutate(methode="facchin")

data_globale <-data_bene2 %>% bind_rows(data_nguyen2) %>% bind_rows(data_facchin2) %>% select(-amt)%>% rename(amt=amt2)
summary(data_globale)
library(compareGroups)

table1 <- compareGroups(methode ~ Pds+Clcreat+age+taille+amt+SEX+greffe,data = data_globale)
                       
restable1 <- createTable(table1, show.all = T)

restable1






```
Franck's model simulation

```{r}
code_bene <- "

[PROB] #modèle Ganciclovir bjcp Franck et al 2020

[SET] end=100, delta=0.1

[PARAM] @annotated


TVKa: 0.73 : typical Ka (/h)
TVF:  0.43: Typical bioavailability (%)
TV1: 9.7 :  typical V1
TV2: 7.6:  typical  V2
TVQ : 10.9 : typical intercompartmental clearance
TVCL : 6.9 : typical CL 
WT :26.7 : median current weight 
CLCREA :148.8: median Cl creat 
CrCL: 0.88 : effet of CrCL on CL


[CMT] @annotated
DEPOT  : Dosing compartment (mg)
CENT : Central compartment
PERI : First peripheral compartment 
 

 [OMEGA] @annotated
ETACL : 0.19 : ETA on clearance
ETAV1 : 0.348 : ETA on V1
ETAKa : 0.49 : ETA on Ka
ETAF : 0.096 : ETA on F 

[MAIN]

double Ka = TVKa*exp(ETAKa);
double CL = TVCL*pow(WT/26.7,0.75)*pow(CLCREA/148.8,CrCL)*exp(ETACL);
double Q = TVQ ;
double V1 = (TV1*WT/26.5)*exp(ETAV1) ;
double V2 = TV2*WT/26.5 ;
F_DEPOT= TVF*exp(ETAF);
ALAG_DEPOT = 0.33;



[SIGMA] @annotated
ADD : 0.0001 : additive Residual unexplained variability 0.98


[ODE]
dxdt_DEPOT = -Ka*DEPOT;
dxdt_CENT = Ka*DEPOT -(CL+Q)*CENT/V1 + Q*PERI/V2 ;
dxdt_PERI = Q*CENT/V1 - Q*PERI/V2 ;

[TABLE] 
capture CP = (CENT/V1)+ADD;
int i = 0;
while(CP<0 && i <100) {
simeps(1);
CP = (CENT/V1) + EPS(1);
++i;
}

"


my_model_bene <- mcode("ganciclovir_model", code_bene)


my_model_bene %>% 
  ev(am = 520 ,ss=1, ii=12) %>%
  Req(CP) %>%
  mrgsim(delta = 0.1, end = 24) %>% 
  plot()

my_model_bene %>% 
  ev(am = 520 ,ss=1, ii=12) %>%
  Req(CP) %>%
  mrgsim(delta = 0.1, end = 24) %>% 
  plot()


data <- expand.ev(ID = 1:10, amt = 520,ii=24, ss=1)#) #2,2.5,3, 3.5, 4
set.seed(2345)
sim_bene <- my_model_bene %>% 
  data_set(data) %>%
  Req(CP) %>%
 mrgsim(delta = 1, end = 24)#%>% 
  #f#ilter(time==24)
  #plot()
  #filter(time==23.9)




```

NGuyen's model simulation

```{r}
code_nguyen <- "

[PROB] #modèle Ganciclovir  Nguyen et al 2021

[SET] end=100, delta=0.1

[PARAM] @annotated


TVKa: 0.506 : typical Ka (/h)
TVF:  0.438: Typical bioavailability (%)
TV1: 5.96 :  typical V1
TV2: 1.29:  typical  V2
TVQ : 0.222 : typical intercompartmental clearance
TVCL : 2.55 : etypical CL 
CRCL : 0.763 : effect ClCr deviation on CL 
WT :26.7 : median current weight 
CLCREA :148.8: median Cl creat 


[CMT] @annotated
DEPOT  : Dosing compartment (mg)
CENT : Central compartment
PERI : First peripheral compartment 
 

[OMEGA] @annotated
ETACL : 0.0556 : ETA on clearance
ETAV1 : 0.0484 : ETA on V1



[MAIN]
 

double Ka = TVKa;
double CL = TVCL*pow(WT/11.7,0.75)*pow(CLCREA/167,CRCL)*exp(ETACL);
double Q = TVQ*pow(WT/11.7,0.75) ;
double V1 = TV1*pow(WT/11.7,1)*exp(ETAV1);
double V2 = TV2*pow(WT/11.7,1) ;
F_DEPOT= TVF;




[SIGMA] @annotated
PROP: 0.0001: proportionnel error 0.477

[ODE]
dxdt_DEPOT = -Ka*DEPOT;
dxdt_CENT = Ka*DEPOT -(CL+Q)*CENT/V1 + Q*PERI/V2 ;
dxdt_PERI = Q*CENT/V1 - Q*PERI/V2 ;

[TABLE] 
capture CP = (CENT/V1)* (1+ EPS(1));
int i = 0;
while(CP<0 && i <100) {
simeps();
CP = (CENT/V1)* (1+ EPS(1)) ;
++i;
}

"


my_model_nguyen <- mcode("ganciclovir_model_nguyen", code_nguyen)


my_model_nguyen %>% 
  ev(am = 520 ,ss=1, ii=24) %>%
  Req(CP) %>%
  mrgsim(delta = 0.1, end = 24) %>% 
  plot()

my_model_nguyen %>% 
  ev(am = 520 ,ss=1, ii=24) %>%
  Req(CP) %>%
  mrgsim(delta = 0.1, end = 24) %>% 
  plot()


data <- expand.ev(ID = 1:10, amt = 520,ii=12, ss=1)#) #2,2.5,3, 3.5, 4
set.seed(2345)
sim_nguyen <- my_model_nguyen %>% 
  data_set(data) %>%
  Req(CP) %>%
 mrgsim(delta = 1, end = 24)#%>% 
  #filter(time==12)
  #plot()
  #filter(time==23.9)




```



Facchin's model simulation

```{r}
code_Facchin <- "

[PROB] #modèle Facchin et al 2009 

[SET] end=100, delta=0.1

[PARAM] @annotated


TVKa: 6.96 : typical Ka (/h)
TVALAG:0.86: typical lag time
TV1: 45 :  typical V1
TV2: 18.5:  typical  V2
TVQ : 1.46 : typical intercompartmental clearance
TVCL:9.07 : clearance typique 
CRCL : -0.768 : effect Creat deviation on CL 
CRBSA: 1.31: effet BSA on cl
VBSA: 1.28: effet BSA on V 
CRSEX:1.15 : effet sexe on cl 
VSEX: 1.14: effet SEX on V 
BSA :1.08  : median BSA
CREA :72.5: median creat 
SEX : 1 : 1 si garçon 0 si fille 


[CMT] @annotated
DEPOT  : Dosing compartment (mg)
CENT : Central compartment
PERI : First peripheral compartment 
 

 [OMEGA] @annotated
ETACL :0.0256 : ETA on clearance
ETAV1 : 0.0086 : ETA on V1
ETAV2 : 0.298 : ETA on V2
ETAKa : 0.350 : ETA on Ka



[MAIN]
 

double Ka = TVKa*exp(ETAKa);
double CL = TVCL*pow(BSA,CRBSA)*pow(CREA/72.5,CRCL)*pow(CRSEX,SEX)*exp(ETACL);
double Q = TVQ ;
double V1 = TV1*pow(BSA,VBSA)*pow(VSEX,SEX)*exp(ETAV1);
double V2 = TV2*exp(ETAV2) ;
ALAG_DEPOT= TVALAG;



[SIGMA] @annotated
ADD: 0.0001: additive error log(0.23)

[ODE]
dxdt_DEPOT = -Ka*DEPOT;
dxdt_CENT = Ka*DEPOT -(CL+Q)*CENT/V1 + Q*PERI/V2 ;
dxdt_PERI = Q*CENT/V1 - Q*PERI/V2 ;

[TABLE] 
capture CP = (CENT/V1)+ EPS(1);
int i = 0;
while(CP<0 && i <100) {
simeps();
CP = (CENT/V1)+ EPS(1);
++i;
}

"


my_model_Facchin <- mcode("ganciclovir_model_Facchin", code_Facchin)


my_model_Facchin %>% 
  ev(am = 400 ,ss=1, ii=24) %>%
  Req(CP) %>%
  mrgsim(delta = 0.1, end = 24) %>% 
  plot()

my_model_Facchin %>% 
  ev(am = 600 ,ss=1, ii=24) %>%
  Req(CP) %>%
  mrgsim(delta = 0.1, end = 24) %>% 
  plot()


data <- expand.ev(ID = 1:10, amt = 520,ii=24, ss=1)#) #2,2.5,3, 3.5, 4
set.seed(2345)
sim_Facchin <- my_model_Facchin %>% 
  data_set(data) %>%
  Req(CP) %>%
 mrgsim(delta = 1, end = 24)#%>% 
  #filter(time==12)
  #plot()
  #filter(time==23.9)




```

```{r}

### Franck model  

e_bene <- expand.ev( ii = 24, ID=1:3596,addl = 5,ss=1) %>%  select(-amt) %>% bind_cols(data_bene)%>% mutate(ID=1:3596)%>%  select(-ID...1,-amt)%>% rename(amt=amt2)


summary(e_bene)

out <- my_model_bene %>% 
  data_set(e_bene) %>%
  Req(CP) %>%
  mrgsim(end = 120, delta = 0.5)

out_bene <- as_tibble(out) %>% left_join(e_bene, by = "ID") %>% filter(CP>0)  

summary(out_bene)

library(PKNCA)


#AUC calculation
auc_trap_bene <- out_bene %>% select(time.x,CP,ii,addl,evid,cmt,amt,ID)%>% rename(dose =amt,OUT=CP,TIME=time.x) %>%
filter(between(TIME,24,48))


data.conc <-PKNCAconc(auc_trap_bene,OUT~TIME|ID)


data_obj <- PKNCAdata(data.conc=data.conc,
                      intervals=data.frame(start=24,
                                           end=48,
                                           aucall=F,
                                           auclast=TRUE,
                                           aucinf.pred=F,
                                           aucinf.obs=F))
results_obj <- pk.nca(data_obj)$result


trap1 <- results_obj %>% dplyr::select(ID, trap =PPORRES) %>% mutate(auc = round(trap,5))%>% dplyr::select(-trap)


simu_auc_bene <-left_join(out_bene,trap1) %>% mutate(methode="bene")
summary(simu_auc_bene)





#### Facchin

e_Facchin <- expand.ev( ii = 24, ID=1:3602,addl = 5,ss=1) %>%  select(-amt) %>% bind_cols(data_facchin)%>% mutate(ID=1:3602)%>%  select(-ID...1,-amt)%>% rename(amt=amt2) %>% mutate(SEX2 = case_when(SEX== "fille"~ "0",SEX== "garcon"~ "1" ))%>% select(-SEX) %>% rename (SEX=SEX2) %>% mutate(BSA=SC_mosteller) %>% mutate (CRE= case_when(age<12~49*taille/Clcreat, age>=12 & SEX <1 ~ 53*taille/Clcreat,age>=12 & SEX>=1 ~ 62*taille/Clcreat ))%>% mutate (CREA = case_when(CRE<350 ~ CRE, CRE>=350 ~ 350))

e_Facchin$SEX=as.numeric(e_Facchin$SEX)
summary(e_Facchin)

out_Facchin <- my_model_Facchin %>% 
  data_set(e_Facchin) %>%
  Req(CP) %>%
  mrgsim(end = 120, delta = 0.5)

out_Facchin <- as_tibble(out_Facchin) %>% left_join(e_Facchin, by = "ID") %>% filter(CP>0)  

summary(out_Facchin)

library(PKNCA)


#AUC calculation
auc_trap_Facchin <- out_Facchin  %>% select(time.x,CP,ii,addl,evid,cmt,amt,ID)%>% rename(dose =amt,OUT=CP,TIME=time.x) %>%
filter(between(TIME,24,48))


data.conc <-PKNCAconc(auc_trap_Facchin,OUT~TIME|ID)


data_obj <- PKNCAdata(data.conc=data.conc,
                      intervals=data.frame(start=24,
                                           end=48,
                                           aucall=F,
                                           auclast=TRUE,
                                           aucinf.pred=F,
                                           aucinf.obs=F))
results_obj <- pk.nca(data_obj)$result


trap1 <- results_obj %>% dplyr::select(ID, trap =PPORRES) %>% mutate(auc = round(trap,5))%>% dplyr::select(-trap)


simu_auc_Facchin<-left_join(out_Facchin ,trap1)%>% mutate(methode="Facchin")
summary(simu_auc_Facchin)

####  Nguyen simulation 

e_nguyen <- expand.ev( ii = 24, ID=1:3602,addl = 5,ss=1) %>%  select(-amt) %>% bind_cols(data_nguyen)%>% mutate(ID=1:3602)%>%  select(-ID...1,-amt)%>% rename(amt=amt2) 


summary(e_nguyen)

out_nguyen <- my_model_nguyen %>% 
  data_set(e_nguyen) %>%
  Req(CP) %>%
  mrgsim(end = 120, delta = 0.5)

out_nguyen <- as_tibble(out_nguyen) %>% left_join(e_nguyen, by = "ID") %>% filter(CP>0)  

summary(out_nguyen)

library(PKNCA)


#AUC calculation 
auc_trap_nguyen<- out_nguyen  %>% select(time.x,CP,ii,addl,evid,cmt,amt,ID)%>% rename(dose =amt,OUT=CP,TIME=time.x) %>%
filter(between(TIME,24,48))


data.conc <-PKNCAconc(auc_trap_nguyen,OUT~TIME|ID)


data_obj <- PKNCAdata(data.conc=data.conc,
                      intervals=data.frame(start=24,
                                           end=48,
                                           aucall=F,
                                           auclast=TRUE,
                                           aucinf.pred=F,
                                           aucinf.obs=F))
results_obj <- pk.nca(data_obj)$result


trap1 <- results_obj %>% dplyr::select(ID, trap =PPORRES) %>% mutate(auc = round(trap,5))%>% dplyr::select(-trap)


simu_auc_nguyen<-left_join(out_nguyen ,trap1)%>% mutate(methode="nguyen")
summary(simu_auc_nguyen)




simu_auc_Facchin$SEX=as.factor(simu_auc_Facchin$SEX)

simu_auc_Facchin<- simu_auc_Facchin%>% mutate(SEX2 = case_when(SEX== "0"~ "fille",SEX== "1"~ "garcon" ))%>% select(-SEX)%>% rename (SEX=SEX2)


simu_auc <- bind_rows(simu_auc_Facchin)%>% bind_rows(simu_auc_nguyen)%>% bind_rows(simu_auc_bene)
summary(simu_auc)

quantile(simu_auc$auc, c(0.05, 0.5, 0.95))

#auc <- simu_auc %>%
        #filter(time.x==48)%>%  filter(auc <= 117 & auc>=18 )


summary(auc)

auc_final <- auc %>% select(Pds, Clcreat,age,taille,amt,auc,SEX,methode,greffe,Clcreat2)
summary(auc_final)




 

auc_final_PO <- auc_final %>% select(-methode,-Clcreat2,-dose_mg,-creat)

auc_final_PO2 <- auc_final_PO  %>% mutate(events=case_when(auc>=40 & auc <=60~ "1", auc >60 ~ "0",auc<40 ~ "0")) %>% select(-auc) %>% mutate(SC_mosteller= sqrt((taille*Pds)/3600)) 

```



```{r}

library(tidymodels)

set.seed(123)

auc_ml_split <- initial_split(auc_final_PO2,strata = events)
auc_ml_train <- training(auc_ml_split)
auc_ml_test  <- testing(auc_ml_split)



folds <- rsample::vfold_cv(auc_ml_train, v = 5)


  

auc_ml_rec <- 
  recipe(events ~ ., data = auc_ml_train) %>%
  step_dummy(greffe,SEX) %>%
  step_zv(all_predictors()) %>%
   step_normalize(all_numeric_predictors())%>%
  themis::step_upsample(events, over_ratio = 0.42)

auc_ml_wflow <- 
  workflow() %>% 
  add_recipe(auc_ml_rec)



prepped <- prep(auc_ml_rec)
prepped


preproc_data <- juice(prepped)
preproc_data

ml_prep_recipe <-  prep(auc_ml_rec )
ml_train_recipe <-juice(ml_prep_recipe)

ml_test_recipe <-bake(ml_prep_recipe, new_data = auc_ml_train)

```



on fait xgboost
```{r}
library(themis)



 xgb_spec <- boost_tree(mode = "classification",
                       mtry = tune(),
                         trees = 1000,
                        min_n = tune(),                        
                        tree_depth = tune(),
                       learn_rate = tune(),
                         sample_size = tune()) %>% set_engine("xgboost")
# 
# 
# #workflow model+recipe
 xgb_wf <- workflow() %>%
   add_recipe(auc_ml_rec) %>%
   add_model(xgb_spec)
# #
# ##hyperparameters
set.seed(2345)
ganciclovir_fold <- vfold_cv(auc_ml_train,strata = events)
# 
# #tuning
set.seed(345)
tune_xgb <- tune_grid(
   xgb_wf,
  resamples = ganciclovir_fold,
   grid = 40, metrics = metric_set(accuracy, roc_auc, f_meas),
   control = control_resamples(save_pred = TRUE)
 )

best_accuracy_xgb <- select_best(tune_xgb, "accuracy")

final_xgb<- finalize_model(
 xgb_spec,
 best_accuracy_xgb
 )
 
 final_xgb
 
 
# #finalize workflow
final_wf_xgb <- workflow() %>%
   add_recipe(auc_ml_rec) %>%
   add_model(final_xgb) %>%
    fit(auc_ml_train)
 
# ###resample#####
  set.seed(456)
  folds <- vfold_cv(auc_ml_train)#par dÃ©faut 10 fois
  set.seed(123)
  xgb_rs <- fit_resamples(object = final_wf_xgb, resamples = folds, control = control_resamples(verbose=T, save_pred = T))
  

   ##perf resample
xgb_rs %>% collect_metrics()
 

   ##confusion matrix
xgb_rs %>%
    collect_predictions() %>%
    conf_mat(events, .pred_class) %>%
    autoplot(type = "heatmap")



##fit workflow
fit_workflow_xgb <- fit(final_wf_xgb, auc_ml_train)



```
random forrest

```{r}


# #model


rf_spec <- rand_forest(mode = "classification",
                        mtry = tune(),
                        trees = 1000,
                        min_n = tune()
                       ) %>% set_engine("ranger", importance = "permutation")



#workflow model+recipe
rf_wf <- workflow() %>%
  add_recipe(auc_ml_rec) %>%
  add_model(rf_spec)
#
##hyperparameters
set.seed(2345)
folds <- vfold_cv(auc_ml_train, strata = events)
```

## Tuning the hyperparameters

<https://www.tidymodels.org/start/tuning/> <https://www.tidymodels.org/learn/work/bayes-opt/>

```{r wf rf tune , cache=T, fig.width=10, fig.height=7}
#tuning

set.seed(345)
tune_rf <- tune_grid(
  rf_wf,
  resamples = folds,
  grid = 30
)

#visualisatin resultats

autoplot(tune_rf) + 
  ggtitle("tuning hyperparameter")

```

## Selection of the best model

```{r wf rf  , cache=T, fig.width=10, fig.height=7}
#choix du best model
best_rf <- select_best(tune_rf, "accuracy")

final_rf <- finalize_model(
  rf_spec,
  best_rf
)

final_rf
```


## finalize workflow and crossval

```{r wf rf wf final }
#finalize workflow
final_wf_rf <- workflow() %>%
  add_recipe(auc_ml_rec) %>%
  add_model(final_rf)

###resample#####
set.seed(456)
folds_cv <- vfold_cv(auc_ml_train, strata = events)#par défaut 10 fois

## 10 fold CV
rf_rs<- fit_resamples(object = final_wf_rf, resamples = folds_cv, control = control_resamples(verbose=T, save_pred = T))

##perf resample
rf_rs %>% collect_metrics()

   

##fit workflow
fit_workflow_rf <- fit(final_wf_rf, auc_ml_train)



```
stack


```{r}
library(stacks)
ctrl_grid <- control_stack_grid()



rand_forest_spec <- 
  rand_forest(
    mtry = tune(),
    min_n = tune(),
    trees = 500
  ) %>%
  set_mode("classification") %>%
  set_engine("ranger")

rand_forest_wflow <-
  auc_ml_wflow %>%
  add_model(rand_forest_spec)

rand_forest_res <- 
  tune_grid(
    object = rand_forest_wflow, 
    resamples = folds, 
    grid = 10,
    control = ctrl_grid
  )


nnet_spec <-
  mlp(hidden_units = tune(), penalty = tune(), epochs = tune()) %>%
  set_mode("classification") %>%
  set_engine("nnet")

nnet_rec <- 
  auc_ml_rec %>% 
  step_normalize(all_predictors())

nnet_wflow <- 
  auc_ml_wflow %>%
  add_model(nnet_spec)

nnet_res <-
  tune_grid(
    object = nnet_wflow, 
    resamples = folds, 
    grid = 10,
    control = ctrl_grid
  )


xgb_spec <- boost_tree(mode = "classification",
                       mtry = tune(),
                         trees = 500,
                        min_n = tune(),                        
                        tree_depth = tune(),
                       learn_rate = tune(),
                         sample_size = tune()) %>% set_engine("xgboost")

xgb_wflow <- 
  auc_ml_wflow %>%
  add_model(xgb_spec)

tune_xgb <- tune_grid(
   xgb_wflow,
  resamples = folds,
   grid = 10, 
   control = ctrl_grid
 )




```

```{r}
auc_ml_model_st <- 
  # initialize the stack
  stacks() %>%
  # add candidate members
  add_candidates(rand_forest_res) %>%
  add_candidates(tune_xgb) %>%
  add_candidates(nnet_res) %>%
  # determine how to combine their predictions
  blend_predictions() %>%
  # fit the candidates with nonzero stacking coefficients
  fit_members()


```


on fait des predictions sur la base test

```{r}
Pds=as.vector(as.matrix(auc_ml_test[,"Pds"]))
Clcreat=as.vector(as.matrix(auc_ml_test[,"Clcreat"]))
taille=as.vector(as.matrix(auc_ml_test[,"taille"]))
SEX=as.vector(as.matrix(auc_ml_test[,"SEX"]))
greffe=as.vector(as.matrix(auc_ml_test[,"greffe"]))
age=as.vector(as.matrix(auc_ml_test[,"age"]))

summary(auc_ml_test)



dose_search <- function(Pds, taille, Clcreat, SEX, greffe, age) {
  amt2 <- ifelse(Clcreat < 150, sqrt((Pds * taille) / 3600) * 7 * Clcreat, sqrt((Pds * taille) / 3600) * 1050)

  seq_length <- ifelse(age <= 2, 5, 5)
  amt_seq <- mapply(function(amt2_val, length) {
    seq(0.1 * amt2_val, length * amt2_val, by = 5)
  }, amt2, seq_length)

  res_tibble <- tibble(id = seq_along(Pds), Pds = Pds, taille = taille, Clcreat = Clcreat, SEX = SEX, greffe = greffe, age = age, amt = amt_seq)

  return(res_tibble)
}



research_test_bis <- dose_search(Pds=Pds,Clcreat = Clcreat,taille=taille,SEX=SEX,greffe=greffe,age=age)

research_test_bis <- research_test_bis %>% unnest(amt) %>% mutate(amt=ifelse(amt>900,900,amt))%>% mutate(SC_mosteller= sqrt((taille*Pds)/3600))
summary(research_test_bis)

library(tidymodels)

library(stacks)


res_dosesearch_test_PO <- research_test_bis %>% mutate(proba=predict(auc_ml_model_st, research_test_bis,type="prob")[[2]])



res_dosesearch_test_PO2 <-res_dosesearch_test_PO %>% group_by(id) %>% filter(proba == max(proba)) 
set.seed(123)
res_dosesearch_test_PO2 <-res_dosesearch_test_PO2 %>%group_by(id)%>% dplyr::slice_sample(n=1)%>% rename(dose_ml=amt)%>% select(proba,dose_ml,id)


```
dose PO des autres modèles

```{r}
### creation de dose faccchin ok article 



nouvelle_dose <- nouvelle_dose %>% mutate(dose_facchin = 50*9.07*((Clcreat/72.5)**(-0.768))*SC_mosteller**1.31*1.15) %>% mutate(auc_Facchin = auc*dose_facchin/amt)

nouvelle_dose <- nouvelle_dose %>%  dplyr::mutate(cible_auc_Facchin = factor(case_when(
  auc_Facchin <= 40 ~ "moins40",
  between(auc_Facchin,40,60) ~"auc_ok",
  auc_Facchin>= 60~"sup 60")))


### Pescovitz litterratrure ok 


nouvelle_dose <- nouvelle_dose %>% mutate (SC_mosteller= sqrt((taille*Pds)/3600))%>% mutate (dose_Pescovitz= case_when(Clcreat<=49 ~ 260*SC_mosteller*0.25,Clcreat >50 & Clcreat <69 ~ 260*SC_mosteller*0.5, Clcreat >=69~ 260*SC_mosteller))%>% mutate(auc_Pescovitz = auc*dose_Pescovitz/amt)

nouvelle_dose <- nouvelle_dose %>%  dplyr::mutate(cible_auc_Pescovitz = factor(case_when(
  auc_Pescovitz <= 40 ~ "moins40",
  between(auc_Pescovitz,40,60) ~"auc_ok",
  auc_Pescovitz>= 60~"sup 60")))
summary(nouvelle_dose)


### jorgan ok litterrature pour algo max sur SC à 150 ml/min/m2 donc on va créer un SC max

nouvelle_dose <- nouvelle_dose  %>% mutate(dose_jorgan = 6*SC_mosteller*Clcreat) %>% mutate(auc_jorgan = auc*dose_jorgan/amt)

nouvelle_dose <- nouvelle_dose %>%  dplyr::mutate(cible_auc_jordan = factor(case_when(
  auc_jorgan <= 40 ~ "moins40",
  between(auc_jorgan,40,60) ~"auc_ok",
  auc_jorgan>= 60~"sup 60")))


#### dose_asperg litt ok 

  
nouvelle_dose <- nouvelle_dose %>% mutate (GFR= SC_mosteller*Clcreat)%>% mutate(dose_asperg = case_when(GFR<= 30 ~  Pds*(0.07*GFR+5), GFR> 30 & Pds>30  ~ Pds*(0.07*GFR+30),GFR> 30 & Pds<=30  ~ Pds*(0.07*GFR+15)))%>% mutate (dose_asperg = case_when(dose_asperg<900 ~ dose_asperg, dose_asperg>=900 ~ 900))%>% mutate(auc_asperg = auc*dose_asperg/amt)

nouvelle_dose <- nouvelle_dose %>%  dplyr::mutate(cible_auc_asperg = factor(case_when(
  auc_asperg <= 40 ~ "moins40",
  between(auc_asperg,40,60) ~"auc_ok",
  auc_asperg>= 60~"sup 60")))




### Nguyen litterature ok 

nouvelle_dose <- nouvelle_dose %>% mutate (dose_nguyen= case_when(Clcreat<=70 ~ 8*Pds,Clcreat >70  ~ 32*Pds))%>% mutate(auc_nguyen = auc*dose_nguyen/amt)

nouvelle_dose <- nouvelle_dose %>%  dplyr::mutate(cible_auc_nguyen = factor(case_when(
  auc_nguyen <= 40 ~ "moins40",
  between(auc_nguyen,40,60) ~"auc_ok",
  auc_nguyen>= 60~"sup 60")))




#### dose bene

nouvelle_dose <- nouvelle_dose %>% mutate (dose_bene= 0.852*(Pds**0.75)*(Clcreat**0.88))%>% mutate(auc_bene = auc*dose_bene/amt)

nouvelle_dose <- nouvelle_dose %>%  dplyr::mutate(cible_auc_bene = factor(case_when(
  auc_bene <= 40 ~ "moins40",
  between(auc_bene,40,60) ~"auc_ok",
  auc_bene>= 60~"sup 60")))

summary(nouvelle_dose)

library(GGally)

nouvelle_dose_long <-  nouvelle_dose %>% select(auc_nguyen,auc_ml,auc_jorgan,auc,auc_bene,auc_Pescovitz) %>% rename(guidelines=auc,Franck=auc_bene,ML=auc_ml,Pescovitz=auc_Pescovitz,Nguyen=auc_nguyen,Jorga=auc_jorgan)



### on stratifie en fonction de l'âge 



#### on separe en fonction des ages 

nouvelle_dose <- nouvelle_dose %>% mutate(class_age= case_when(age <= 2 ~ "< 2 years",
  between(age,2,12) ~"2<age<12 years",
  age>= 12~">12 years"))



nouvelle_dose_inf2 <- nouvelle_dose %>% filter(class_age=="< 2 years")
nouvelle_dose_2_12 <- nouvelle_dose %>% filter(class_age=="2<age<12 years")
nouvelle_dose_sup2 <- nouvelle_dose %>% filter(class_age==">12 years")


summary(nouvelle_dose)


library(GGally)

nouvelle_dose_long <-  nouvelle_dose %>% select(auc,auc_ml,auc_Facchin, auc_Pescovitz,auc_bene,auc_asperg, auc_jorgan,auc_nguyen,auc_asperg,auc_Facchin) %>% rename (Guidelines=auc,ML=auc_ml,Facchin= auc_Facchin,Franck=auc_bene,Asberg=auc_asperg,Jorga= auc_jorgan,Nguyen=auc_nguyen)

nouvelle_dose_long <-pivot_longer(nouvelle_dose_long, cols = c(Guidelines,ML,Facchin,Franck,Asberg,Jorga,Nguyen ))%>% rename(Dose=name)
nouvelle_dose_long<- nouvelle_dose_long  %>%  dplyr::mutate(auc = factor(case_when(
  value <= 40 ~ "<40",
  between(value,40,60) ~"40-60",
  value>= 60~">60")))

nouvelle_dose_long$auc <- fct_relevel(nouvelle_dose_long$auc, c("<40", "40-60", ">60"))
                                                       
ggbivariate_PO_basesimu <-ggbivariate(nouvelle_dose_long, outcome = "auc", explanatory = c("Dose")) + scale_fill_manual(values = c("aquamarine","chartreuse 1","brown2"))
ggbivariate_PO_basesimu



### moins de 2 ans 

nouvelle_dose_long_inf2 <-  nouvelle_dose_inf2 %>% select(auc,auc_ml,auc_Facchin, auc_Pescovitz,auc_bene,auc_asperg, auc_jorgan,auc_nguyen,auc_asperg,auc_Facchin) %>% rename (Guidelines=auc,ML=auc_ml,Facchin= auc_Facchin,Franck=auc_bene,Asberg=auc_asperg,Jorga= auc_jorgan,Nguyen=auc_nguyen)


nouvelle_dose_long_inf2 <-pivot_longer(nouvelle_dose_long_inf2, cols = c(Guidelines, ML,Facchin,Franck,Asberg,Jorga,Nguyen))
nouvelle_dose_long_inf2<- nouvelle_dose_long_inf2  %>%  dplyr::mutate(cible_auc = factor(case_when(
  value <= 40 ~ "<40",
  between(value,40,60) ~"40_60",
  value>= 60~">60")))

nouvelle_dose_long_inf2$cible_auc <- fct_relevel(nouvelle_dose_long_inf2$cible_auc, c("<40", "40_60", ">60"))

nouvelle_dose_long_inf2<- nouvelle_dose_long_inf2  %>% rename (AUC=cible_auc,Dose=name)                                       
summary(nouvelle_dose_inf2)
library(GGally)            
ggbivariate_PO_basesimu_basetest_inf2 <- ggbivariate(nouvelle_dose_long_inf2, outcome = "AUC", explanatory = c("Dose")) + scale_fill_manual(values = c("aquamarine","chartreuse 1","brown2")) 
ggbivariate_PO_basesimu_basetest_inf2


#ggsave("ggbivariate_PO_basesimu_basetest_inf2.pdf")

### 2/12

nouvelle_dose_long_2_12 <-  nouvelle_dose_2_12 %>% select(auc,auc_ml,auc_Facchin, auc_Pescovitz,auc_bene,auc_asperg, auc_jorgan,auc_nguyen,auc_asperg,auc_Facchin) %>% rename (Guidelines=auc,ML=auc_ml,Facchin= auc_Facchin,Franck=auc_bene,Asberg=auc_asperg,Jorga= auc_jorgan,Nguyen=auc_nguyen)

nouvelle_dose_long_2_12 <-pivot_longer(nouvelle_dose_long_2_12, cols = c(Guidelines, ML,Facchin,Franck,Asberg,Jorga,Nguyen ))
nouvelle_dose_long_2_12<- nouvelle_dose_long_2_12  %>%  dplyr::mutate(cible_auc = factor(case_when(
  value <= 40 ~ "<40",
  between(value,40,60) ~"40_60",
  value>= 60~">60")))
summary(nouvelle_dose_long_2_12)

nouvelle_dose_long_2_12$cible_auc <- fct_relevel(nouvelle_dose_long_2_12$cible_auc, c("<40", "40_60", ">60"))

nouvelle_dose_long_2_12<- nouvelle_dose_long_2_12  %>% rename (AUC=cible_auc,Dose=name)                                       

library(GGally)            
ggbivariate_PO_basesimu_basetest_2_12 <- ggbivariate(nouvelle_dose_long_2_12, outcome = "AUC", explanatory = c("Dose")) + scale_fill_manual(values = c("aquamarine","chartreuse 1","brown2")) 
ggbivariate_PO_basesimu_basetest_2_12


#ggsave("ggbivariate_PO_basesimu_basetest_2_12.pdf")

#### plus de 12 


nouvelle_dose_long_sup12 <-  nouvelle_dose_sup2 %>% select(auc,auc_ml,auc_Facchin, auc_Pescovitz,auc_bene,auc_asperg, auc_jorgan,auc_nguyen,auc_asperg,auc_Facchin) %>% rename (Guidelines=auc,ML=auc_ml,Facchin= auc_Facchin,Franck=auc_bene,Asberg=auc_asperg,Jorga= auc_jorgan,Nguyen=auc_nguyen)


nouvelle_dose_long_sup12 <-pivot_longer(nouvelle_dose_long_sup12, cols = c(Guidelines, ML,Facchin,Franck,Asberg,Jorga,Nguyen ))
nouvelle_dose_long_sup12<- nouvelle_dose_long_sup12  %>%  dplyr::mutate(cible_auc = factor(case_when(
  value <= 40 ~ "<40",
  between(value,40,60) ~"40_60",
  value>= 60~">60")))

summary(nouvelle_dose_long_sup12)


nouvelle_dose_long_sup12$cible_auc <- fct_relevel(nouvelle_dose_long_sup12$cible_auc, c("<40", "40_60", ">60"))

nouvelle_dose_long_sup12<- nouvelle_dose_long_sup12  %>% rename (AUC=cible_auc,Dose=name)                                       

library(GGally)            
ggbivariate_PO_basesimu_basetest_sup12 <- ggbivariate(nouvelle_dose_long_sup12, outcome = "AUC", explanatory = c("Dose")) + scale_fill_manual(values = c("aquamarine","chartreuse 1","brown2")) 
ggbivariate_PO_basesimu_basetest_sup12

#ggsave("ggbivariate_PO_basesimu_basetest_sup12.pdf")

#saveRDS(nouvelle_dose, "nouvelle_dose_PO_basesimu_basetest_alex_janv24.rds")
#saveRDS(nouvelle_dose_long, "nouvelle_dose_IV_basesimu_basetest.rds")
#nouvelle_dose<-readRDS("nouvelle_dose_PO_basesimu_basetest_alex_janv24.rds")
summary(nouvelle_dose)
```



on regarde sur la base externe

```{r}
base_externe1 <- read_csv("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/Val_po_20191210.csv", na = c("", "NA", "D", "K", "A", "NF"),locale = locale("fr")) 

base_externe1 <- base_externe1 %>% select( CREAT,DOSE,EVID,POIDS,ID)%>% rename (Pds=POIDS)%>% mutate(CREAT=lead(CREAT))%>% filter (EVID=="1")

base_externe2 <- read_csv("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/gcvch.csv", na = c("", "NA", "D", "K", "A", "NF"),locale = locale("fr")) 

#base_externe2 <- base_externe2 %>% select(WT,HGT,BSA,DOSE,EVID,ID,SCHWADJ,AGE)%>% rename (Pds=WT, Clcreat= SCHWADJ,taille=HGT,age=AGE )%>% dplyr::filter (EVID=="1") %>% select (Pds, Clcreat,taille,ID,DOSE,EVID) %>% mutate(SC_mosteller= sqrt((taille*Pds)/3600))

base_externe2<- read_csv("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/val_potouspts_AA_20191217.csv", na = c("", "NA", "D", "K", "A", "NF"),locale = locale("fr"))%>% select(WT,HGT,BSA,DOSE,EVID,ID,SCHWADJ,AGE,SEX)%>% rename (Pds=WT, Clcreat= SCHWADJ,taille=HGT,age=AGE ) %>% filter (EVID=="1") %>% select (Pds, Clcreat,taille,ID,DOSE,age,SEX) %>% mutate(SC_mosteller= sqrt((taille*Pds)/3600)) %>% mutate(lieu="norway")%>% mutate(SEX2=case_when(SEX=="1"~"garcon",SEX=="0"~"fille")) %>% select(-SEX)%>% rename(SEX=SEX2)%>% mutate(greffe="moelle")%>% mutate(INTERDOSE=24)


base_externe3 <- read_csv("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/val_touspoints_po.csv", na = c("", "NA", "D", "K", "A", "NF"),locale = locale("fr")) 
base_externe3 <- base_externe3 %>% select( WT,DOSE,EVID,CLSC,ID,DOSE,INTERDOSE)%>% rename (Pds=WT, Clcreat =CLSC )%>% filter (EVID=="1")%>% mutate(lieu="canada") %>% mutate(greffe="solide")

### il faut calculer taille a partir SC modififié 

base_externe3 <- base_externe3 %>% mutate(SC_mosteller= (4*Pds+7)/(90+Pds))  %>% mutate(taille= ((3600*SC_mosteller*SC_mosteller)/Pds)) %>% select(Pds, Clcreat,taille,ID,SC_mosteller,DOSE,lieu,INTERDOSE,greffe)
base_externe3$DOSE=as.numeric(base_externe3$DOSE)
### il faut rajouter age  
library(readxl)
age_base3 <- read_xls("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/PK-GCV_demog_val20190530_code.xls") 

age_base3 <- age_base3  %>% mutate(ID2=str_replace_all(age_base3$ID, "D", " "))%>% select(ID2,age,sex)%>% rename(ID=ID2)  %>% mutate(SEX=case_when(sex=="1"~"garcon",sex=="2"~"fille"))

age_base3 <- age_base3  %>% dplyr::add_row(ID = "90a", age=8.77,SEX="garcon") %>% dplyr::add_row(ID = "90b", age=8.77,SEX="garcon") %>% dplyr::add_row(ID = "90c", age=8.77,SEX="garcon") %>% dplyr::add_row(ID = "231a", age=0.63,SEX="garcon") %>% dplyr::add_row(ID = "231b", age=0.63,SEX="garcon")%>% dplyr::add_row(ID = "231c", age=0.63,SEX="garcon") %>% dplyr::add_row(ID = "258a", age=16.22,SEX="fille") %>% dplyr::add_row(ID = "258b", age=16.22,SEX="fille") %>% dplyr::add_row(ID = "258c", age=16.22,SEX="fille") %>% dplyr::add_row(ID = "348a", age=1.04,SEX="garcon") %>% dplyr::add_row(ID = "348b", age=1.04,SEX="garcon") %>% dplyr::add_row(ID = "558a", age=5.87,SEX="garcon")%>% dplyr::add_row(ID = "558b", age=5.87,SEX="garcon")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

base_externe4 <- base_externe3 %>% left_join(age_base3)
  
txt1 <- read_table("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/AUC_ref_anemone_pk_gcv_conc_val150219_po.txt")

txt2 <- read_table("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/AUC_ref_anemone_val111219_po.txt")

txt3 <- read_table("~/OneDrive/thèsescience/ganciclovir/ganciclovir/base_externe/AUC_ref_trapeze_AA_20191217.txt") %>% rename(AUC_benedicte_trapeze=AUC_trapeze)


AUC_base_externe <- txt1 %>% bind_rows(txt2) %>% bind_rows(txt3)%>% rename (ID=Nom)

base_externe2$ID=as.character(base_externe2$ID)
base_externe2$INTERDOSE=as.numeric(base_externe2$INTERDOSE)

base_externe_fusion <- base_externe2 %>% bind_rows(base_externe4)

base_externe_final <- AUC_base_externe %>% left_join(base_externe_fusion)%>%rename(amt=DOSE)%>% filter(!is.na(age)) %>% select(-sex)
base_externe_final$INTERDOSE=as.factor(base_externe_final$INTERDOSE)
summary(base_externe_final)

```

On regarde les performances de la base externe

```{r}
Pds=as.vector(as.matrix(base_externe_final[,"Pds"]))
Clcreat=as.vector(as.matrix(base_externe_final[,"Clcreat"]))
taille=as.vector(as.matrix(base_externe_final[,"taille"]))
SEX=as.vector(as.matrix(base_externe_final[,"SEX"]))
greffe=as.vector(as.matrix(base_externe_final[,"greffe"]))
age=as.vector(as.matrix(base_externe_final[,"age"]))

### on change eq_length <- ifelse(age <= 2, 5, 10)

dose_search <- function(Pds, taille, Clcreat, SEX, greffe, age) {
  amt2 <- ifelse(Clcreat < 150, sqrt((Pds * taille) / 3600) * 7 * Clcreat, sqrt((Pds * taille) / 3600) * 1050)

  seq_length <- ifelse(age <= 2, 5, 5)
  amt_seq <- mapply(function(amt2_val, length) {
    seq(0.5 * amt2_val, length * amt2_val, by = 5)
  }, amt2, seq_length)

  res_tibble <- tibble(id = seq_along(Pds), Pds = Pds, taille = taille, Clcreat = Clcreat, SEX = SEX, greffe = greffe, age = age, amt = amt_seq)

  return(res_tibble)
}



research_test_base_ext <- dose_search(Pds=Pds,Clcreat = Clcreat,taille=taille,SEX=SEX,greffe=greffe,age=age)
research_test_base_ext_bis <- research_test_base_ext %>% unnest(amt) %>% mutate(amt=ifelse(amt>900,900,amt))%>% mutate(SC_mosteller= sqrt((taille*Pds)/3600))


res_dosesearch_test_baseext <- research_test_base_ext_bis %>% mutate(proba=predict(auc_ml_model_st, research_test_base_ext_bis,type="prob")[[2]])

#res_dosesearch_test_baseext <-res_dosesearch_test_baseext %>% group_by(id) %>% filter(proba == max(proba))%>% dplyr::slice(n=1)%>% rename(dose_ml=amt)%>% select(proba,dose_ml,id)

#res_dosesearch_test_baseext <-res_dosesearch_test_baseext %>% group_by(id) %>% filter(proba == max(proba))%>% rename(dose_ml=amt)%>% select(proba,dose_ml,id)


res_dosesearch_test_baseext <-res_dosesearch_test_baseext %>% group_by(id) %>% filter(proba == max(proba))


res_dosesearch_test_baseext <-res_dosesearch_test_baseext  %>% group_by(id)%>% dplyr::slice_sample(n=1)%>% rename(dose_ml=amt)%>% select(proba,dose_ml,id)
summary(res_dosesearch_test_baseext)






table_simulation_baseext <- res_dosesearch_test_baseext %>% bind_cols(base_externe_final) 










#### calcul de l'auc avec la dose_ml
summary(table_simulation_baseext)

#saveRDS(table_simulation_baseext, "table_simulation_baseext_PO_alex_janv24.rds")
             

table_simulation_baseext <- table_simulation_baseext %>% mutate(auc_ml = AUC_benedicte_trapeze*dose_ml/amt)

 
table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_ml = factor(case_when(
  auc_ml <= 40 ~ "moins40",
  between(auc_ml,40,60) ~"auc_ok",
  auc_ml>= 60~"sup 60")))

summary(table_simulation_baseext)

table_simulation_baseext %>% select(cible_auc_ml,auc_ml,AUC_benedicte_trapeze,dose_ml,amt,INTERDOSE)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_ml_boxplot = factor(case_when(
  auc_ml <= 40 ~ "non",
  between(auc_ml,40,60) ~"dans la cible",
  auc_ml>= 60~"non ")))





### creation de dose faccchin ok article 



table_simulation_baseext <- table_simulation_baseext %>% mutate(dose_facchin = 50*9.07*((Clcreat/72.5)**(-0.768))*SC_mosteller**1.31*1.15) %>% mutate(auc_Facchin = AUC_benedicte_trapeze*dose_facchin/amt)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_Facchin = factor(case_when(
  auc_Facchin <= 40 ~ "moins40",
  between(auc_Facchin,40,60) ~"auc_ok",
  auc_Facchin>= 60~"sup 60")))


### Pescovitz litterratrure ok 


table_simulation_baseext <- table_simulation_baseext %>% mutate (SC_mosteller= sqrt((taille*Pds)/3600))%>% mutate (dose_Pescovitz= case_when(Clcreat<=49 ~ 260*SC_mosteller*0.25,Clcreat >50 & Clcreat <69 ~ 260*SC_mosteller*0.5, Clcreat >=69~ 260*SC_mosteller))%>% mutate(auc_Pescovitz = AUC_benedicte_trapeze*dose_Pescovitz/amt)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_Pescovitz = factor(case_when(
  auc_Pescovitz <= 40 ~ "moins40",
  between(auc_Pescovitz,40,60) ~"auc_ok",
  auc_Pescovitz>= 60~"sup 60")))



### dose reco 

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_reco = factor(case_when(
  AUC_benedicte_trapeze <= 40 ~ "moins40",
  between(AUC_benedicte_trapeze,40,60) ~"auc_ok",
  AUC_benedicte_trapeze>= 60~"sup 60")))
summary(table_simulation_baseext)

#### dose_asperg litt ok 

  
table_simulation_baseext <- table_simulation_baseext %>% mutate (GFR= SC_mosteller*Clcreat)%>% mutate(dose_asperg = case_when(GFR<= 30 ~  Pds*(0.07*GFR+5), GFR> 30 & Pds>30  ~ Pds*(0.07*GFR+30),GFR> 30 & Pds<=30  ~ Pds*(0.07*GFR+15)))%>% mutate (dose_asperg = case_when(dose_asperg<900 ~ dose_asperg, dose_asperg>=900 ~ 900))%>% mutate(auc_asperg = AUC_benedicte_trapeze*dose_asperg/amt)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_asperg = factor(case_when(
  auc_asperg <= 40 ~ "moins40",
  between(auc_asperg,40,60) ~"auc_ok",
  auc_asperg>= 60~"sup 60")))




### Nguyen litterature ok 

table_simulation_baseext <- table_simulation_baseext %>% mutate (dose_nguyen= case_when(Clcreat<=70 ~ 8*Pds,Clcreat >70  ~ 32*Pds))%>% mutate(auc_nguyen = AUC_benedicte_trapeze*dose_nguyen/amt)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_nguyen = factor(case_when(
  auc_nguyen <= 40 ~ "moins40",
  between(auc_nguyen,40,60) ~"auc_ok",
  auc_nguyen>= 60~"sup 60")))

summary(table_simulation_baseext)


#### dose bene

table_simulation_baseext <- table_simulation_baseext %>% mutate (dose_bene= 0.852*(Pds**0.75)*(Clcreat**0.88))%>% mutate(auc_bene = AUC_benedicte_trapeze*dose_bene/amt)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_bene = factor(case_when(
  auc_bene <= 40 ~ "moins40",
  between(auc_bene,40,60) ~"auc_ok",
  auc_bene>= 60~"sup 60")))

summary(table_simulation_baseext)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(realite = factor(case_when(
  AUC_benedicte_trapeze <= 40 ~ "non",
  between(AUC_benedicte_trapeze,40,60) ~"oui",
  AUC_benedicte_trapeze>= 60~"non")))

table_simulation_baseext <- table_simulation_baseext  %>% mutate(dose_jorgan = 5*SC_mosteller*Clcreat) %>% mutate(auc_jorgan = AUC_benedicte_trapeze*dose_jorgan/amt)

table_simulation_baseext <- table_simulation_baseext %>%  dplyr::mutate(cible_auc_jordan = factor(case_when(
  auc_jorgan <= 40 ~ "moins40",
  between(auc_jorgan,40,60) ~"auc_ok",
  auc_jorgan>= 60~"sup 60")))


table_simulation_baseext$SEX=as.factor(table_simulation_baseext$SEX)
table_simulation_baseext$greffe=as.factor(table_simulation_baseext$greffe)
summary(table_simulation_baseext)
#table_simulation_baseext<- table_simulation_baseext%>% mutate(dose_mg=dose_ml2/Pds)
#saveRDS(table_simulation_baseext, "table_simulation_baseext_PO.rds")
#table_simulation_baseext<-readRDS("table_simulation_baseext_PO.rds")

library(ggplot2)


p <- ggplot(table_simulation_baseext, aes(x=realite, y=proba)) + 
  geom_boxplot()
p



```


```{r}
nouvelle_dose_long_baseext <-  table_simulation_baseext %>% select(AUC_benedicte_trapeze,auc_ml,auc_Facchin, auc_Pescovitz,auc_bene,auc_asperg, auc_jorgan,auc_nguyen,auc_asperg,auc_Facchin) %>% rename (Guidelines=AUC_benedicte_trapeze,ML=auc_ml,Facchin= auc_Facchin,Franck=auc_bene,Asberg=auc_asperg,Jorga= auc_jorgan,Nguyen=auc_nguyen)

summary(table_simulation_baseext)
nouvelle_dose_long_baseext2 <-pivot_longer(nouvelle_dose_long_baseext, cols = c(Guidelines,ML,Facchin,Franck,Asberg,Jorga,Nguyen ))%>% rename(Dose=name)

nouvelle_dose_long_baseext2<- nouvelle_dose_long_baseext2  %>%  dplyr::mutate(auc = factor(case_when(
  value <= 40 ~ "<40",
  between(value,40,60) ~"40-60",
  value>= 60~">60")))


nouvelle_dose_long_baseext2$auc <- fct_relevel(nouvelle_dose_long_baseext2$auc, c("<40", "40-60", ">60"))

library(GGally)
ggbivariate_PO_baseext <- ggbivariate(nouvelle_dose_long_baseext2, outcome = "auc", explanatory = c("Dose")) +
  scale_fill_brewer(type = "qual")  + scale_fill_manual(values = c("aquamarine","chartreuse 1","brown2"))

ggbivariate_PO_baseext
#ggsave("ggbivariate_PO_baseext_alex.pdf")

```
on fait les ggpaired

```{r}
summary(nouvelle_dose)
library(ggcorrplot)
library(ggpubr)
simu_inf40 <- nouvelle_dose %>% filter(auc < 40) %>% dplyr::select(auc,dose_ml,amt) 
summary(simu_sup60)
simu_inf40_ggplot<- simu_inf40%>% ggpaired(cond1 = "amt", cond2 = "dose_ml", line.size = 0.01,title = "") + ggtitle("AUC < 40 simulated patients") +  scale_x_discrete(labels = c("amt" = "guidelines doses","dose_ml" = "ML doses"))+ theme(plot.title = element_text(size=10), axis.title.x =element_text(size=5),axis.title.y =element_blank(),axis.ticks = element_blank())+ xlab("")  + ylab("") # +coord_trans(y="log10")+ scale_y_continuous(name = " dose log 10",breaks=NULL)  + xlab("")  + ylab("log dose")

simu_inf40_ggplot

simu_40_60 <- nouvelle_dose %>% filter(auc > 40 & auc<60) %>% dplyr::select(auc,dose_ml,amt) 

simu_40_60_ggplot<- simu_40_60%>% ggpaired(cond1 = "amt", cond2 = "dose_ml", line.size = 0.01,title = "") + ggtitle("AUC 40_60 simulated patients") +  scale_x_discrete(labels = c("amt" = "guidelines doses","dose_ml" = "ML doses"))  + theme(plot.title = element_text(size=10), axis.title.x =element_text(size=5),axis.title.y =element_blank(),axis.ticks = element_blank())  + xlab("")  + ylab("")# +coord_trans(y="log10")+ scale_y_continuous(name = " dose log 10",breaks=NULL) 
simu_40_60_ggplot

simu_sup60 <- nouvelle_dose %>% filter(auc > 60) %>% dplyr::select(auc,dose_ml,amt) 

simu_sup60_ggplot<- simu_sup60%>% ggpaired(cond1 = "amt", cond2 = "dose_ml", line.size = 0.01,title = "") + ggtitle("AUC > 60 simulated patients ") +  scale_x_discrete(labels = c("amt" = "guidelines doses","dose_ml" = "ML doses")) + theme(plot.title = element_text(size=10), axis.title.x =element_text(size=5),axis.title.y =element_blank(),axis.ticks = element_blank())+ xlab("")  + ylab("") # +coord_trans(y="log10")+ scale_y_continuous(name = " dose log 10",breaks=NULL)  + xlab("")  + ylab("log dose")

simu_sup60_ggplot


#### dans la base externe 


summary(table_simulation_baseext)

table_simulation_baseext <- table_simulation_baseext %>% mutate(dose_reco=7*Clcreat*SC_mosteller) %>% mutate(dose_reco2 = case_when(amt<900 ~ amt, amt>=900 ~ 900)) %>% select(-dose_reco) %>% rename(dose_reco=dose_reco2)
#base_externe_final_simuIV <- base_externe_final_simuIV %>% mutate(dose_mg = amt/Pds/2)

simu_inf40_basext <- table_simulation_baseext %>% filter(AUC_benedicte_trapeze < 40) %>% dplyr::select(AUC_benedicte_trapeze,dose_ml,dose_reco,amt) 

simu_inf40_basext_ggplot<- simu_inf40_basext%>% ggpaired(cond1 = "dose_reco", cond2 = "dose_ml", line.size = 0.1,title = "") + ggtitle("AUC < 40 real patients") +  scale_x_discrete(labels = c("dose_reco" = "guidelines doses","dose_ml" = "ML doses"))+ theme(plot.title = element_text(size=10), axis.title.x =element_text(size=5),axis.title.y =element_blank(),axis.ticks = element_blank())+ xlab("")  + ylab("") # +coord_trans(y="log10")+ scale_y_continuous(name = " dose log 10",breaks=NULL)  + xlab("")  + ylab("log dose")

simu_inf40_basext_ggplot

simu_40_60_basext <- table_simulation_baseext %>% filter(AUC_benedicte_trapeze > 40 & AUC_benedicte_trapeze<60) %>% dplyr::select(AUC_benedicte_trapeze,dose_ml,dose_reco) 

simu_40_60_ggplot_basext<- simu_40_60_basext%>% ggpaired(cond1 = "dose_reco", cond2 = "dose_ml", line.size = 0.1,title = "") + ggtitle("AUC 40_60 real patients ") +  scale_x_discrete(labels = c("dose_reco" = "guidelines doses","dose_ml" = "ML doses"))  + theme(plot.title = element_text(size=10), axis.title.x =element_text(size=5),axis.title.y =element_blank(),axis.ticks = element_blank())+ xlab("")  + ylab("") # +coord_trans(y="log10")+ scale_y_continuous(name = " dose log 10",breaks=NULL)  + xlab("")  + ylab("log dose")
simu_40_60_ggplot_basext

simu_sup60_basext <- table_simulation_baseext %>% filter(AUC_benedicte_trapeze > 60) %>% dplyr::select(AUC_benedicte_trapeze,dose_ml,dose_reco) 

simu_sup60_ggplot_basext<- simu_sup60_basext%>% ggpaired(cond1 = "dose_reco", cond2 = "dose_ml", line.size = 0.1,title = "") + ggtitle("AUC > 60 real patients") +  scale_x_discrete(labels = c("dose_reco" = "guidelines doses","dose_ml" = "ML doses")) + theme(plot.title = element_text(size=10), axis.title.x =element_text(size=5),axis.title.y =element_blank(),axis.ticks = element_blank())+ xlab("")  + ylab("") # +coord_trans(y="log10")+ scale_y_continuous(name = " dose log 10",breaks=NULL)  + xlab("")  + ylab("log dose")

simu_sup60_ggplot_basext





library(cowplot)
# simple grid
figure_PO_dose <- plot_grid(simu_inf40_ggplot,simu_inf40_basext_ggplot,simu_40_60_ggplot,simu_40_60_ggplot_basext,simu_sup60_ggplot, simu_sup60_ggplot_basext,ncol=2,nrow=3)
figure_PO_dose


```


